<%- include('../partials/header.ejs') %>
<%- include('../partials/page_header.ejs') %>

<style>
  .product-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>

<main class="main">
  <!-- Slider section -->
  <div id="carouselExampleAutoplaying" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="/user_assets/imgs/slider/Banner_4.webp" class="d-block w-100" alt="...">
      </div>
      <div class="carousel-item">
        <img src="/user_assets/imgs/slider/Banner_2.webp" class="d-block w-100" alt="...">
      </div>
      <div class="carousel-item">
        <img src="/user_assets/imgs/slider/Banner_3.webp" class="d-block w-100" alt="...">
      </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleAutoplaying" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleAutoplaying" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>

  <!-- View Collections section -->
  <section class="product-tabs pt-25 pb-20 wow fadeIn animated">
    <div class="container">
      <div class="row mt-5">
        <div class="col-12 text-center">
          <div class="upside-down-rectangle">
            <div class="d-flex align-items-center justify-content-center" style="height: 100%">
              <h2 class="text-decoration-underline">View Collections</h2>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-50">
        <div class="col-4 text-center" style="border-radius: 20px">
          <a href="#">
            <img src="/fimg/view_collectin_1.webp" alt="Image 1" class="img-fluid" style="max-width: 100%; max-height: 400px; border-radius: 20px">
          </a>
        </div>
        <div class="col-4 text-center" style="border-radius: 20px">
          <a href="#">
            <img src="/fimg/view_collectin_2.webp" alt="Image 2" class="img-fluid" style="max-width: 100%; max-height: 400px; border-radius: 20px">
          </a>
        </div>
        <div class="col-4 text-center" style="border-radius: 20px">
          <a href="#">
            <img src="/fimg/view_collectin_3.webp" alt="Image 3" class="img-fluid" style="max-width: 100%; max-height: 400px; border-radius: 20px">
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Bestsellers section -->
  <section class="product-tabs pt-25 pb-20 wow fadeIn animated">
    <div class="container">
      <div class="row mb-50">
        <div class="col-12 text-center">
          <div class="upside-down-rectangle">
            <div class="d-flex align-items-center justify-content-center" style="height: 100%">
              <h2 class="text-decoration-underline">Bestsellers</h2>
            </div>
          </div>
        </div>
      </div>
      <div class="row product-grid-4">
        <% for (let i=0; i<4; i++) { %>
        <div class="col-lg-3 col-md-4 col-12 col-sm-6">
          <div class="product-cart-wrap mb-30">
            <div class="product-img-action-wrap">
              <div class="product-img product-img-zoom">
                <a href="/load_product?id=<%= products[i].id %>">
                  <img class="default-img" style="height: 100%" src="/uploads/<%= products[i].media[0] %>" alt="<%= products[i].media[0] %>">
                  <img class="hover-img" style="height: 100%" src="/uploads/<%= products[i].media[0] %>" alt="<%= products[i].media[0] %>">
                </a>
              </div>
            </div>
            <div class="product-content-wrap">
              <div class="product-category">
                <a href="/load_product?id=<%= products[i]._id %>"><%= products[i].category %></a>
              </div>
              <h2 class="product-name">
                <a href="/load_product?id=<%= products[i].id %>"><%= products[i].name %></a>
              </h2>
              <div class="rating-result" title="90%">
                <span><span>90%</span></span>
              </div>
              <div class="product-price" style="font-family: sans-serif;">
                    <% if (products[i].offerPrice) { %>
                      <span>$<%= products[i].offerPrice %></span>
                      <span class="old-price">$<%= products[i].price %></span>
                    <% } else { %>
                      <span>$<%= products[i].price %></span>
                    <% } %>
                  </div>
              <div class="product-action-1 show">
                <a aria-label="Add To Cart" class="action-btn hover-up"
                  <% if (user) { %>
                    onclick="addToCart('<%= products[i]._id %>')"
                  <% } else { %>
                    onclick="goHome()"
                  <% } %>
                >
                  <i class="fi-rs-shopping-bag-add"></i>
                </a>
                <a aria-label="Add To Wishlist" class="action-btn hover-up" <% if (user) { %>
                      onclick="addToWishlist('<%= products[i]._id%>')"
                      <% } else { %>
                        onclick="goHome()"
                        <% } %>>
                  <i class="fi-rs-heart"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
        <% } %>
      </div>
    </div>
  </section>

  <!-- Casio Banner section -->
  <section class="product-tabs pt-25 pb-20 wow fadeIn animated">
    <div class="container">
      <img src="/fimg/last_banner.png" alt="Your Image">
    </div>
  </section>

  <!-- All Products section -->
  <section class="product-tabs pt-25 pb-20 wow fadeIn animated">
    <div class="container">
      <div class="row mb-50">
        <div class="col-12 text-center">
          <div class="upside-down-rectangle">
            <div class="d-flex align-items-center justify-content-center" style="height: 100%">
              <h2 class="text-decoration-underline">Browse our products</h2>
            </div>
          </div>
        </div>
      </div>
      <div class="row product-grid-4">
        <% for (let i=0; i<products.length; i++) { %>
        <div class="col-lg-3 col-md-4 col-12 col-sm-6">
          <div class="product-cart-wrap mb-30">
            <div class="product-img-action-wrap">
              <div class="product-img product-img-zoom">
                <a href="/load_product?id=<%= products[i].id %>">
                  <img class="default-img" style="height: 100%" src="/uploads/<%= products[i].media[0] %>" alt="<%= products[i].media[0] %>">
                  <img class="hover-img" style="height: 100%" src="/uploads/<%= products[i].media[0] %>" alt="<%= products[i].media[0] %>">
                </a>
              </div>
            </div>
            <div class="product-content-wrap">
              <div class="product-category">
                <a href="/load_product?id=<%= products[i]._id %>"><%= products[i].category %></a>
              </div>
              <h2 class="product-name">
                <a href="/load_product?id=<%= products[i].id %>"><%= products[i].name %></a>
              </h2>
              <div class="rating-result" title="90%">
                <span><span>90%</span></span>
              </div>
              <div class="product-price" style="font-family: sans-serif;">
                    <% if (products[i].offerPrice) { %>
                      <span>$<%= products[i].offerPrice %></span>
                      <span class="old-price">$<%= products[i].price %></span>
                    <% } else { %>
                      <span>$<%= products[i].price %></span>
                    <% } %>
                  </div>
              <div class="product-action-1 show">
                <a aria-label="Add To Cart" class="action-btn hover-up"
                  <% if (user) { %>
                    onclick="addToCart('<%= products[i]._id %>')"
                  <% } else { %>
                    onclick="goHome()"
                  <% } %>
                >
                  <i class="fi-rs-shopping-bag-add"></i>
                </a>
                <a aria-label="Add To Wishlist" class="action-btn hover-up" <% if (user) { %>
                      onclick="addToWishlist('<%= products[i]._id%>')"
                      <% } else { %>
                        onclick="goHome()"
                        <% } %>>
                  <i class="fi-rs-heart"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
        <% } %>
      </div>
      <div class="text-center">
        <button class="btn" style="background-color: black">
          <a href="/shop" style="color: white">View All Products</a>
        </button>
      </div>
    </div>
  </section>

  <!-- Guarantees -->
  <section class="featured section-padding">
    <div class="container pb-25">
      <div class="row">
        <div class="col-lg-2 col-md-4 mb-md-3 mb-lg-0">
          <div class="banner-features wow fadeIn animated hover-up">
            <img src="/user_assets/imgs/theme/icons/feature-1.png" alt="">
            <h4 class="bg-1">Free Shipping</h4>
          </div>
        </div>
        <div class="col-lg-2 col-md-4 mb-md-3 mb-lg-0">
          <div class="banner-features wow fadeIn animated hover-up">
            <img src="/user_assets/imgs/theme/icons/feature-2.png" alt="">
            <h4 class="bg-3">Online Order</h4>
          </div>
        </div>
        <div class="col-lg-2 col-md-4 mb-md-3 mb-lg-0">
          <div class="banner-features wow fadeIn animated hover-up">
            <img src="/user_assets/imgs/theme/icons/feature-3.png" alt="">
            <h4 class="bg-2">Save Money</h4>
          </div>
        </div>
        <div class="col-lg-2 col-md-4 mb-md-3 mb-lg-0">
          <div class="banner-features wow fadeIn animated hover-up">
            <img src="/user_assets/imgs/theme/icons/feature-4.png" alt="">
            <h4 class="bg-4">Promotions</h4>
          </div>
        </div>
        <div class="col-lg-2 col-md-4 mb-md-3 mb-lg-0">
          <div class="banner-features wow fadeIn animated hover-up">
            <img src="/user_assets/imgs/theme/icons/feature-5.png" alt="">
            <h4 class="bg-5">Happy Sell</h4>
          </div>
        </div>
        <div class="col-lg-2 col-md-4 mb-md-3 mb-lg-0">
          <div class="banner-features wow fadeIn animated hover-up">
            <img src="/user_assets/imgs/theme/icons/feature-6.png" alt="">
            <h4 class="bg-6">24/7 Support</h4>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<!-- Slider logic -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let carouselItems = document.querySelectorAll(".carousel-item");

    document.querySelector(".carousel-control-prev").addEventListener("click", function () {
      let activeItem = document.querySelector(".carousel-item.active");
      let prevItem = activeItem.previousElementSibling || carouselItems[carouselItems.length - 1];
      activeItem.classList.remove("active");
      prevItem.classList.add("active");
      setTimeout(function () {
        prevItem.classList.remove("carousel-item-prev");
        activeItem.classList.remove("carousel-item-active");
        activeItem.classList.add("carousel-item-next");
      }, 50);
    });

    document.querySelector(".carousel-control-next").addEventListener("click", function () {
      let activeItem = document.querySelector(".carousel-item.active");
      let nextItem = activeItem.nextElementSibling || carouselItems[0];
      activeItem.classList.remove("active");
      nextItem.classList.add("active");
      setTimeout(function () {
        nextItem.classList.remove("carousel-item-next");
        activeItem.classList.remove("carousel-item-active");
        activeItem.classList.add("carousel-item-prev");
      }, 50);
    });
  });
</script>

<!-- Add to cart logic -->
<script>
  async function addToCart(productId) {
    try {
      const response = await fetch("/check_product_in_cart", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          productId: productId,
        }),
      });

      if (!response.ok) {
        throw new Error("Failed to check product in cart");
      }

      const data = await response.json();

      if (data.exists) {
        Swal.fire({
          title: "Product Already in Cart",
          text: "This product is already in your cart.",
          icon: "warning",
          confirmButtonText: "Go to Cart",
          showCancelButton: true,
        }).then((value) => {
          if (value.isConfirmed) {
            window.location.href = "/cart";
          }
        });
      } else {
        const addToCartResponse = await fetch("/add_to_cart", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            productId: productId,
          }),
        });

        if (!addToCartResponse.ok) {
          throw new Error("Failed to add product to cart");
        }

        const cartData = await addToCartResponse.json();
        console.log("Product added to cart successfully:", cartData);
        window.location.href = "/cart";
      }
    } catch (error) {
      console.error("Error adding product to cart:", error.message);
      Swal.fire("Error", "Failed to add product to cart. Please try again later.", "error");
    }
  }

  // Go to home page (for add to cart).
  function goHome() {
    window.location.href = "/login";
  }

  // Add to Wishlist Function
async function addToWishlist(productId) {
  console.log(`product id : ${productId}`);
  try {
    const response = await fetch('/wishlist_check', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        productId: productId
      })
    });

    console.log('response : ',response);

    if (!response.ok) {
      throw new Error('Failed to check product in wishlist.');
    }

    const data = await response.json();

    if (data.exists) {
      Swal.fire({
        title: 'Product Already in Wishlist',
        text: 'This product is already in your wishlist.',
        icon: 'warning',
        confirmButtonText: 'View Wishlist',
        showCancelButton: true
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = '/wishlist';
        }
      });
    } else {
      const addToWishlistResponse = await fetch('/add_to_wishlist', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          productId: productId
        })
      });

      if (!addToWishlistResponse.ok) {
        throw new Error('Failed to add product to wishlist.');
      }

      const wishlistData = await addToWishlistResponse.json();
      console.log('Product added to wishlist successfully:', wishlistData);
      window.location.href = '/wishlist';
    }
  } catch (error) {
    console.error('Error adding product to wishlist:', error);
    Swal.fire('Error', 'Failed to add product to wishlist. Please try again later.', 'error');
  }
}

</script>

<%- include('../partials/page_footer.ejs') %>
<%- include('../partials/footer.ejs') %>
